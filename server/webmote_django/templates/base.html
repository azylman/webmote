<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
    {% if 1 %}
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"> 
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" />
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js"></script>
    <script type="text/javascript" charset="utf-8">

        $(document).ready(function() {
            $("a").attr("rel","external");

            $('.on_off_light').change(function() {
                var el = $(this).children('select');
                var deviceID = el.attr('id').split('-')[1];
                var state = el.attr('value') == "on" ? 1:0;
                $.ajax({
                    url : '/setstate/' + deviceID + '/' + state,
                });
            });

            $('.dimmable_light').change(function() {
                var el = $(this).children('input');
                var deviceID = el.attr('id').split('-')[1];
                var state = el.attr('value');
                $.ajax({
                    url : '/setstate/' + deviceID + '/' + state,
                });
            });

            $('#selectDeviceType').change(function() {
                var divID = 'div.deviceForm#' +$(this).val();
                $('div.deviceForm').each(function() {
                    $(this).css("display", "none");
                });
                $(divID).css("display", "inline");
            });

            $('#user-0, #device-0').change(function () {
                $('input[id^=' + this.id.split('-')[0] + ']').attr('checked',this.checked).checkboxradio('refresh');
            });

            $('[id^=user-]').change(function () {
                if (this.id.split('-')[1] > 0) {
                    // Determine howmany others are checked
                    var numChecked = 0;
                    var checkedID = 0;
                    $('[id^=user-]').each(function(index) {
                        if (this.id.split('-')[1] > 0 && this.checked) {
                            numChecked++;
                            checkedID = this.id.split('-')[1];
                        }
                    });
                    if (numChecked == 1) {
                        // Get information about user's current permissions
                        $.getJSON('/user_permissions_info/' + checkedID + '/', function(data) {
                            for (i = 0; i < data.length; i++) {
                                $('#device-' + data[i]).attr('checked',true).checkboxradio('refresh');
                            }
                        });
                    }
                    if (numChecked == 2 || numChecked== 0) {
                        // Clear 
                        $('[id^=device-]').attr('checked', false).checkboxradio('refresh');
                    }
                }
            });
        });

        function getSelectedProfile() {
            return $('#selectProfile option:selected')[0].value;
        }

        function runCommand(url) {
            $.ajax({
                url : url,
            });
        }

        // This doesn't ensure order so the bug here is that the clear may arrive after one of the sets. The logic needs to be reworked at some point to send a single object at once so this problem cannot happen.
        function savePermissions() {
            $('[id^=user-]').each(function(index) {
                var userID = this.id.split('-')[1];
                if (userID > 0 && this.checked) {
                    // Clear a users existing permissions
                    runCommand('/user_permissions/' + userID + '/0/');
                    $('[id^=device-]').each(function(index) {
                        var deviceId = this.id.split('-')[1];
                        if (deviceId > 0 && this.checked) {
                            runCommand('/user_permissions/' + userID + '/' + deviceId + '/');
                        }
                    });
                }
            });
        }

	    $(document).live("mobileinit", function(){
	      $.mobile.ajaxFormsEnabled = false;
	    });

	    $(document).live("mobileinit", function(){
	      $.mobile.ajaxLinksEnabled = false;
	    });
    </script>



    <!--Dialog Boxes-->
<!--    <link rel="stylesheet" type="text/css" href="http://dev.jtsage.com/cdn/simpledialog/latest/jquery.mobile.simpledialog.min.css" />-->
<!--    <script type="text/javascript" src="http://dev.jtsage.com/cdn/simpledialog/latest/jquery.mobile.simpledialog.min.js"></script>-->
    {% endif %}

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>{% block title %}{% endblock %}</title>
    {% if error %}
    <script>alert('{{ error }}');</script>
    {% endif %}
</head>

<body id="{% block body_id %}{% endblock %}">
    <div id="body">
        {% comment %}
        <nav>
            <a href="/">Home</a>
            <a href="/ir">IR Remotes</a>
            <a href="/lights">Lights</a>
            <a href="/devices/">All Devices</a>
            <a href="/setup/">Setup/Config</a>
            <a href="/logout/" data-icon="delete">Logout</a>
        </nav>
        {% endcomment %}

        {% block body %}
        <div>
            <div data-role="header" data-position="inline">
        	    <a href="/" data-icon="home">Home</a>
        	    <h1>{% block page_title %}{% endblock %}</h1>
        	    <a href="/logout/" data-icon="delete">Logout</a>
            </div>
            {% block content_title %}{% endblock %}
        </div>
        <div class="content">
            {% block content %}{% endblock %}
        </div>
        {% endblock %}
    </div>
</body>
</html>
